# SDDワークフロー詳細

本プロジェクトの仕様駆動開発ワークフローの詳細ガイド。

## 目次

1. [Forward フロー詳細](#1-forward-フロー詳細)
2. [Backward フロー詳細](#2-backward-フロー詳細)
3. [コミット粒度](#3-コミット粒度)
4. [要件ID払い出しルール](#4-要件id払い出しルール)
5. [設計書の同期ルール](#5-設計書の同期ルール)
6. [手戻り時の対応](#6-手戻り時の対応)

---

## 1. Forward フロー詳細

### 1.1 全体フロー図

```
┌────────────────┐
│  Issue作成     │  GitHub Issue #nn（起点）
│  (なぜ作るか)   │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   要件定義     │  docs/specs/requirements/REQ-xxx.md
│  (何を作るか)   │  ※ GitHub Issue欄に #nn を記載
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   詳細仕様     │  docs/specs/domain/master/Xxx.spec.md
│  (どう作るか)   │  docs/specs/domain/features/Xxx.{feature}.spec.md
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  タスク分解    │  docs/specs/domain/features/Xxx.{feature}.tasks.md
│  (何をやるか)   │  ※ 仕様書からタスクを導出
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  テストコード  │  src/**/__tests__/Xxx.test.ts
│  (検証方法)    │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│    実装        │  src/**/Xxx.ts
│  (コード)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ トレーサビリティ│  要件 ← 仕様 ← テスト ← 実装
│    更新        │  全てのリンクを確認
└────────────────┘
```

### 1.2 各フェーズの詳細

#### /sdd init {issue番号}

**目的**: SDDワークフローの開始

**実行内容**:
1. `gh issue view {issue番号}` でIssue内容を取得
2. 要件の概要を把握
3. 要件ID（REQ-{カテゴリ}-{連番}）を決定
   - カテゴリ例: CSV, VERSION, TASK, PROJECT
4. featureブランチ名を提案
   - 形式: `feature/{issue番号}-{機能名}`
5. バージョンをSNAPSHOT形式に更新
   - 形式: `X.Y.Z-SNAPSHOT.{機能名}`

**出力例**:
```
## Issue #42 分析結果

### 概要
計算除外レコードの可視化機能

### 推奨設定
- 要件ID: REQ-TASK-001
- ブランチ: feature/42-excluded-tasks
- バージョン: 0.0.21-SNAPSHOT.excluded-tasks

### 次のステップ
/sdd requirements REQ-TASK-001
```

#### /sdd requirements {REQ-ID}

**目的**: 要件定義書の作成

**成果物**: `docs/specs/requirements/{REQ-ID}.md`

**必須セクション**:
- ヘッダー（要件ID, GitHub Issue, 作成日, ステータス, 優先度）
- 概要
- 背景・目的
- 機能要件
- 非機能要件
- 受け入れ基準（AC-ID形式: AC-01, AC-02, ...）
- インターフェース設計（案）
- 関連ドキュメント

#### /sdd design {機能名}

**目的**: 案件設計書の作成

**成果物**: `docs/specs/domain/features/{クラス名}.{機能名}.spec.md`

**必須セクション**:
- ヘッダー（バージョン, 作成日, 要件ID, ソースファイル）
- 概要
- インターフェース仕様（型定義、メソッドシグネチャ）
- 処理仕様（ロジック、擬似コード）
- テストケース（TC-ID形式）
  - 正常系（TC-01〜）
  - 境界値（TC-nn〜）
  - 異常系（TC-mm〜）
- **要件トレーサビリティ**（AC-ID → TC-ID対応表）
- 変更履歴

#### /sdd tasks {機能名}

**目的**: タスク管理ファイルの作成

**成果物**: `docs/specs/domain/features/{クラス名}.{機能名}.tasks.md`

**進捗記号**:
| 状態 | 記号 | 意味 |
|------|------|------|
| Todo | ⬜ | 未着手 |
| In Progress | 🔄 | 作業中 |
| Done | ✅ | 完了 |
| Blocked | ⏸️ | ブロック中 |

#### /sdd impl {機能名}

**目的**: 仕様に基づく実装

**実行内容**:
1. tasks.md の未完了タスクを確認
2. テストコード作成（テストファースト）
   - 仕様書のテストケースに対応
   - この時点ではテストは失敗する
3. 実装コード作成
   - 仕様書のインターフェース仕様に従う
4. テスト実行・PASS確認
5. tasks.md の進捗を更新

#### /sdd verify {機能名}

**目的**: 実装と仕様の整合性確認

**チェック項目**:
1. 仕様書のテストケース一覧 vs 実装されたテストコード
2. 要件トレーサビリティ（AC → TC → 実装）
3. マスター設計書への反映状況

---

## 2. Backward フロー詳細

### 2.1 全体フロー図

```
┌────────────────┐
│  既存コード    │  src/**/Xxx.ts（既存）
│   分析        │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   仕様書       │  docs/specs/domain/master/Xxx.spec.md
│   作成        │  （コードから逆算）
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  テストコード  │  src/**/__tests__/Xxx.test.ts
│   追加        │  （仕様を検証）
└────────────────┘
```

### 2.2 /sdd backward {ファイルパス}

**実行内容**:
1. 対象ファイルを読み込み
2. クラス・メソッドの構造を分析
   - 公開API（export）の抽出
   - メソッドシグネチャの解析
   - 依存関係の把握
3. 仕様書テンプレートに沿って文書化
4. テストケースを導出
5. `docs/specs/domain/master/{クラス名}.spec.md` に出力

---

## 3. コミット粒度

| # | フェーズ | コミットメッセージ例 | 含める内容 |
|---|---------|---------------------|-----------|
| 1 | 要件定義 | `docs: XXXの要件定義を追加 (REQ-XXX-001)` | 要件定義書（Draft） |
| 2 | 仕様書 | `docs: XXXの詳細仕様を追加` | 仕様書 |
| 3 | テスト | `test: XXXのテストを追加` | テストコード（この時点では失敗） |
| 4 | 実装 | `feat: XXXを実装` | 実装コード + エクスポート追加 |
| 5 | トレーサビリティ | `docs: REQ-XXX-001のトレーサビリティを更新` | 要件定義書（Approved） |

**粒度の判断基準**: 1コミット = 1つの「状態遷移」

---

## 4. 要件ID払い出しルール

### 原則

**機能追加・拡張は、新規要件IDを払い出す**。既存要件定義書の「改訂」は限定的なケースのみ。

| 変更内容 | 対応 |
|---------|------|
| 新しいプロパティ/メソッド追加 | **新規要件ID払い出し** |
| 新しい機能の追加 | **新規要件ID払い出し** |
| 既存動作の変更（破壊的変更） | **新規要件ID払い出し** |
| バグ修正（仕様通りに修正） | 既存要件IDの改訂 |
| 表記修正・明確化 | 既存要件IDの改訂 |

### 命名規則

```
REQ-{カテゴリ}-{連番}

例:
- REQ-CSV-001    # CSV関連の1番目
- REQ-TASK-001   # Task関連の1番目
- REQ-PROJECT-001 # Project関連の1番目
```

---

## 5. 設計書の同期ルール

### 案件設計書 → マスター設計書

| 案件設計書の変更 | マスター設計書への反映 |
|-----------------|---------------------|
| 要件トレーサビリティの追加・修正 | ✅ 必須 |
| テストケースの追加・修正 | ✅ 必須 |
| インターフェース仕様の変更 | ✅ 必須 |
| 変更履歴の更新 | ✅ 必須 |

### 反映タイミング

- **PRマージ前**（featureブランチ内で実施）
- トレーサビリティ更新の一環として実施
- 案件仕様書は履歴として残す（削除しない）

---

## 6. 手戻り時の対応

### 同一案件の開発中に気づいた設計ミス

```
気づき発生（テスト作成中/実装中）
    │
    ▼
┌─────────────────────────────┐
│ 要件定義書への影響を確認     │
└─────────────┬───────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
    ▼                   ▼
影響あり             影響なし
    │                   │
    ▼                   │
要件定義書を修正       │
    │                   │
    └─────────┬─────────┘
              │
              ▼
        仕様書を修正
              │
              ▼
        テストを修正
              │
              ▼
        実装を修正/続行
              │
              ▼
    トレーサビリティ確認
```

### 大幅な設計変更が必要な場合

以下の場合は、要件定義からやり直すことを検討：
- 機能の目的自体が変わった
- 対象クラス/モジュールが根本的に違った
- 受け入れ基準を満たせない設計だった
