# REQ-FILTER-STATS-001: タスクフィルタリングと統計情報

## 概要

GitHub Issue [#120](https://github.com/masatomix/evmtools-node/issues/120) の要件定義書。

テキストフィルタしたTaskRow達に対して、統計情報を出力する機能を提供する。プロジェクト全体だけでなく、一部のタスク群に対してのみの統計を出力可能にする。

## 背景・目的

### 背景

現在の evmtools-node では、プロジェクト全体の EVM 指標（PV, EV, SPI 等）は取得できるが、特定のタスク群（例: 特定の機能、特定の担当者のタスク）に絞った統計情報を取得する手段がない。

### 目的

- 特定のタスク群に対する EVM 指標を算出可能にする
- タスクのフィルタリング機能を提供する
- フィルタリング結果に対する統計情報（タスク数、工数、遅延情報）を提供する

## 機能要件

### FR-01: タスクフィルタリング

| ID | 要件 |
|----|------|
| FR-01-1 | fullTaskName（タスクのフルパス名）による部分一致検索ができること |

> **将来対応**: 複数のフィルタ条件を組み合わせて使用する機能は将来バージョンで対応予定

### FR-02: 統計情報の算出

| ID | 要件 |
|----|------|
| FR-02-1 | フィルタ結果に対する EVM 指標（PV合計, EV合計, SPI）を算出できること |
| FR-02-2 | ETC'（残作業予測）と完了予測日を算出できること |
| FR-02-3 | フィルタ結果のタスク数を算出できること |
| FR-02-4 | 担当者別の統計（タスク数、PV、EV、ETC'、遅延情報）を算出できること |
| FR-02-4-1 | フィルタ結果に対しても担当者別統計を算出できること |
| FR-02-5 | 遅延情報（遅延タスク数、遅延日数）を算出できること |

### FR-03: 出力形式

| ID | 要件 |
|----|------|
| FR-03-1 | プログラム API として利用できること（TypeScript/JavaScript） |
| FR-03-2 | CLI コマンドとして実行できること |

## 非機能要件

### NFR-01: パフォーマンス

| ID | 要件 |
|----|------|
| NFR-01-1 | 1000タスクのフィルタリングが 100ms 以内に完了すること |

### NFR-02: 互換性

| ID | 要件 |
|----|------|
| NFR-02-1 | 既存の Project, TaskRow API との互換性を維持すること |
| NFR-02-2 | 既存のテストが全て PASS すること |
| NFR-02-3 | `project.getStatistics()` を引数なしで呼び出した場合、既存の動作（プロジェクト全体の統計）を維持すること |

### NFR-03: 保守性

| ID | 要件 |
|----|------|
| NFR-03-1 | クリーンアーキテクチャに従い、domain 層に実装すること |
| NFR-03-2 | 単体テストのカバレッジ 80% 以上を達成すること |

## 受け入れ基準

| AC-ID | 基準 | 対応する機能要件 |
|-------|------|-----------------|
| AC-01 | fullTaskName に "認証機能" を含むタスクのみが抽出されること | FR-01-1 |
| AC-02 | フィルタ結果に対して PV 合計、EV 合計、SPI が正しく算出されること | FR-02-1 |
| AC-03 | フィルタ結果に対して ETC' と完了予測日が算出されること | FR-02-2 |
| AC-04 | フィルタ結果のタスク数が正しくカウントされること（統計計算はリーフタスクのみ） | FR-02-3 |
| AC-05 | 担当者別にタスク数、PV、EV、ETC'、遅延情報が集計されること | FR-02-4 |
| AC-05-1 | `project.getStatisticsByName({ filter: "認証機能" })` でフィルタ結果の担当者別統計を取得できること | FR-02-4-1 |
| AC-05-2 | `project.getStatisticsByName(filteredTasks)` で渡された TaskRow[] の担当者別統計を取得できること | FR-02-4-1 |
| AC-06 | 遅延タスク数と遅延日数の統計が取得できること | FR-02-5 |
| AC-07 | `project.getStatistics({ filter: "認証機能" })` でフィルタ結果の統計情報を取得できること | FR-03-1 |
| AC-08 | `project.getStatistics()` を引数なしで呼び出すとプロジェクト全体の統計を返すこと | FR-03-1, NFR-02-3 |
| AC-09 | `project.filterTasks({ filter: "認証機能" })` でフィルタ結果の TaskRow[]（親タスク含む）を取得できること | FR-03-1 |
| AC-10 | `project.getStatistics(filteredTasks)` で渡された TaskRow[] に対する統計を取得できること | FR-03-1 |

> **次回スコープ**: AC-11（CLI で `pbevm-filter-stats --filter "認証機能"` が実行できること）は次回対応予定

## 関連ドキュメント

- [GLOSSARY.md](../../GLOSSARY.md) - EVM用語、ドメインモデル定義
- [Project.spec.md](../domain/master/Project.spec.md) - Project クラス仕様
- [TaskRow.spec.md](../domain/master/TaskRow.spec.md) - TaskRow クラス仕様

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-24 | 1.0.0 | 初版作成 |
| 2026-01-24 | 1.1.0 | FR-01-2（親タスクID指定）を削除、API設計を修正（getStatistics にフィルタ引数を追加、TaskRow[]を渡す形式も追加） |
| 2026-01-25 | 1.2.0 | FR-01-2（複数フィルタ）を将来対応に変更、FR-02-4-1/AC-05-1/AC-05-2（getStatisticsByName フィルタ対応）追加、AC-04/AC-09 修正（filterTasks は親含む全タスクを返す）、AC-11 を次回スコープに変更 |
