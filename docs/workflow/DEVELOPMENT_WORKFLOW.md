# 開発ワークフロー

**作成日**: 2025-12-16
**バージョン**: 1.0.0

---

## 1. 概要

本プロジェクトでは、**Git Flow** ブランチ戦略と**仕様駆動開発（Spec-Driven Development）**を組み合わせた開発ワークフローを採用しています。

---

## 2. 開発フロー詳細

### 2.1 全体フロー図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           開発ワークフロー全体図                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│       【Issue First + 仕様駆動開発 (Forward)】                              │
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌────────┐│
│  │ 0.Issue │───▶│ 1. 要件  │───▶│ 2. 仕様  │───▶│ 3.テスト │───▶│ 4.実装 ││
│  │  作成   │    │   定義   │    │   作成   │    │ コード   │    │        ││
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └────────┘│
│       │              │                                               │      │
│       │              ▼                                               ▼      │
│       │         ┌──────────┐                                   ┌──────────┐ │
│       │         │ REQ-xxx  │                                   │  全テスト │ │
│       │         │ Issue #nn│                                   │   PASS   │ │
│       │         └──────────┘                                   └────┬─────┘ │
│       │                                                             │       │
│  ═════╪═════════════════════════════════════════════════════════════╪═════  │
│       │                                                             │       │
│       │    【Git Flow】                                             ▼       │
│       │                                                       ┌──────────┐  │
│       ▼    ┌──────────┐    ┌──────────┐    ┌──────────┐      │トレーサビ│  │
│  ┌──────────┐feature  │───▶│   PR     │───▶│ develop  │      │リティ更新│  │
│  │  #nn    ││ ブランチ │    │Closes #nn│    │ マージ   │      └──────────┘  │
│  │ (起点)  │└──────────┘    └──────────┘    └──────────┘                     │
│  └──────────┘                                   │                            │
│                                                 ▼                            │
│                                           ┌──────────┐    ┌──────────┐      │
│                                           │ release  │───▶│   main   │      │
│                                           │ ブランチ │    │  + タグ  │      │
│                                           └──────────┘    └──────────┘      │
│                                                                │             │
│                                                                ▼             │
│                                                           Issue #nn         │
│                                                           自動クローズ       │
└─────────────────────────────────────────────────────────────────────────────┘
```

**人間が最初にやること**: GitHub Issue を作成する（または既存Issueを確認する）

### 2.2 仕様駆動開発（Spec-Driven Development）

本プロジェクトでは、SDDスキル（`/sdd`コマンド）により仕様駆動開発ワークフローをサポートしている。

| コマンド | 機能 | 引数 |
|---------|------|------|
| `/sdd init` | SDDワークフロー開始、Issue確認 | `{issue番号}` |
| `/sdd requirements` | 要件定義書の作成 | `{REQ-ID}` |
| `/sdd design` | 案件設計書の作成 | `{機能名}` |
| `/sdd tasks` | タスク管理ファイルの作成 | `{機能名}` |
| `/sdd impl` | 仕様に基づく実装 | `{機能名}` |
| `/sdd verify` | 実装と仕様の整合性確認 | `{機能名}` |
| `/sdd status` | 進捗状況確認 | `{機能名}` (省略可) |
| `/sdd backward` | 既存コードの文書化 | `{ファイルパス}` |

> **詳細**: SDDスキルの詳細は [`.claude/skills/sdd/SKILL.md`](../../.claude/skills/sdd/SKILL.md) を参照。

以下のセクションでは、SDDワークフローの**Why（なぜそうするのか）**を説明する。

#### 2.2.1 Forward フロー（新規開発）

```
┌────────────────┐
│  Issue作成     │  GitHub Issue #nn（起点）
│  (なぜ作るか)   │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   要件定義     │  docs/specs/requirements/REQ-xxx.md
│  (何を作るか)   │  ※ GitHub Issue欄に #nn を記載
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   詳細仕様     │  docs/specs/domain/master/Xxx.spec.md
│  (どう作るか)   │  docs/specs/domain/features/Xxx.{feature}.spec.md
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  タスク分解    │  docs/specs/domain/features/Xxx.{feature}.tasks.md
│  (何をやるか)   │  ※ 仕様書からタスクを導出
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  テストコード  │  src/**/__tests__/Xxx.test.ts
│  (検証方法)    │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│    実装        │  src/**/Xxx.ts
│  (コード)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│ トレーサビリティ│  要件 ← 仕様 ← テスト ← 実装
│    更新        │  全てのリンクを確認
└────────────────┘
```

##### 2.2.1.1 コミット粒度（2025/12/22現在）

> **注意**: 開発フローに習熟するまでは、以下の粒度でコミットすることを推奨します。
> 習熟後は、状況に応じて柔軟に運用してください。

| # | フェーズ | コミットメッセージ例 | 含める内容 |
|---|---------|---------------------|-----------|
| 1 | 要件定義 | `docs: XXXの要件定義を追加 (REQ-XXX-001)` | 要件定義書（Draft） |
| 2 | 仕様書 | `docs: XXXの詳細仕様を追加` | 仕様書 |
| 3 | テスト | `test: XXXのテストを追加` | テストコード（この時点では失敗） |
| 4 | 実装 | `feat: XXXを実装` | 実装コード + エクスポート追加 |
| 5 | トレーサビリティ | `docs: REQ-XXX-001のトレーサビリティを更新` | 要件定義書（Approved） |

**粒度の判断基準**: 1コミット = 1つの「状態遷移」

| 状態遷移 | コミットすべき理由 |
|---------|------------------|
| 要件なし → 要件Draft | 「何を作るか」が確定 |
| 要件のみ → 仕様あり | 「どう作るか」が確定 |
| 仕様のみ → テストあり | 検証方法が確定（テストファースト） |
| テスト失敗 → テストPASS | 実装完了の証拠 |
| Draft → Approved | 受け入れ完了 |

**例外ケース**:
- 軽微な修正（typo等）: 1コミットにまとめてOK
- 複数ファイル同時修正（実装+エクスポート）: 関連する変更は1コミット
- テスト失敗の修正: 実装コミットに含める

#### 2.2.2 Backward フロー（既存コード文書化）

```
┌────────────────┐
│  既存コード    │  src/**/Xxx.ts（既存）
│   分析        │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│   仕様書       │  docs/specs/domain/master/Xxx.spec.md
│   作成        │  （コードから逆算）
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  テストコード  │  src/**/__tests__/Xxx.test.ts
│   追加        │  （仕様を検証）
└────────────────┘
```

#### 2.2.3 成果物の関係

```
docs/specs/requirements/
├── REQ-CSV-001.md          ─────┐
                                 │ トレーサビリティ
docs/specs/domain/master/        │
├── CsvProjectCreator.spec.md ◀──┤
├── CsvProjectCreator.spec.yaml  │
                                 │
src/infrastructure/              │
├── CsvProjectCreator.ts    ◀────┤
├── __tests__/                   │
│   ├── CsvProjectCreator.test.ts ◀──┘
│   └── CsvProjectCreator.integration.test.ts
```

> **📝 ドキュメント内のファイル参照について**
>
> 要件定義書・設計書でファイルパスを記載する際は、Markdownの相対パスリンクを使用すること。
>
> ```markdown
> <!-- ✅ 良い例：相対パスリンク -->
> | 設計書 | [`CsvProjectCreator.spec.md`](../domain/master/CsvProjectCreator.spec.md) |
> | テスト | [`CsvProjectCreator.test.ts`](../../../src/infrastructure/__tests__/CsvProjectCreator.test.ts) |
>
> <!-- ❌ 悪い例：リンクなしのパス表記 -->
> | 設計書 | `docs/specs/domain/master/CsvProjectCreator.spec.md` |
> ```
>
> これにより、GitHub上やVSCodeでクリックによるファイル参照が可能になる。

##### 2.2.3.1 案件仕様書とマスター設計書

仕様書には2種類ある：

| 種類 | 配置場所 | 役割 | 例 |
|------|---------|------|-----|
| **マスター設計書** | `domain/master/` | クラス全体の仕様 | `master/Project.spec.md` |
| **案件仕様書** | `domain/features/` | 案件で追加した機能の仕様 | `features/Project.excludedTasks.spec.md` |

**ファイル構成:**

```
docs/specs/domain/
├── master/                            # マスター設計書
│   ├── Project.spec.md
│   ├── Project.spec.yaml
│   ├── TaskRow.spec.md
│   └── ...
└── features/                          # 案件仕様書
    └── Project.excludedTasks.spec.md  # REQ-TASK-001
```

**featureブランチ内でのマスター設計書への反映:**

```
案件仕様書                          マスター設計書
(Project.excludedTasks.spec.md)     (Project.spec.md)
         │                                 │
         │  featureブランチ内で            │
         └────────────────────────────────▶│ 反映
                                           │
                                    ・メソッド追加
                                    ・変更履歴に記載
```

**反映内容:**

| 項目 | マスター設計書への反映 |
|------|----------------------|
| 新規メソッド/プロパティ | メソッド仕様セクションに追加 |
| 変更履歴 | 変更履歴セクションに案件ID・日付・概要を追記 |
| テストケース | テストシナリオセクションに追加（または参照） |

**反映タイミング:**
- **PRマージ前**（featureブランチ内で実施）
- トレーサビリティ更新の一環として実施
- 案件仕様書は履歴として残す（削除しない）

**developへのマージ条件:**
- ✅ テストPASS
- ✅ マスター設計書が更新されていること

#### 2.2.4 トレーサビリティで実現できること

| 実現できること | 説明 | 具体例 |
|--------------|------|-------|
| **影響範囲の特定** | 要件変更時に、どの仕様・テスト・コードに影響するか即座に把握 | REQ-CSV-001の変更 → CsvProjectCreator.spec.md → CsvProjectCreator.ts → テスト |
| **テスト漏れ防止** | 要件に対応するテストが存在するか確認可能 | 要件IDからテストケースを逆引き |
| **コードの存在理由** | なぜそのコードが存在するのか、根拠を辿れる | `parseRow()`メソッド → 仕様書 → 要件「CSVの各行をパースする」 |
| **レビュー効率化** | PRレビュー時に要件・仕様との整合性を確認しやすい | 仕様書のテストケース一覧 vs 実際のテストコード |
| **新メンバーのオンボーディング** | 機能の全体像を要件→仕様→コードの流れで理解できる | 「CSV読込機能を理解したい」→ REQ-CSV-001.md から読み始める |

#### 2.2.5 改修時の運用ルール

仕様書には**変更履歴**を残し、トレーサビリティを維持する。

##### 仕様書ヘッダーの更新

```markdown
# CsvProjectCreator 詳細仕様

バージョン: 1.1.0              ← 改修時にバージョンアップ
作成日: 2025-12-16
更新日: 2025-12-20              ← 最終更新日を追記
要件ID: REQ-CSV-001, REQ-CSV-002  ← 新要件があれば追加
ソースファイル: src/infrastructure/CsvProjectCreator.ts
```

##### 変更履歴セクションの追加

```markdown
## 変更履歴

| バージョン | 日付 | 変更内容 | 要件ID |
|-----------|------|---------|--------|
| 1.0.0 | 2025-12-16 | 初版作成 | REQ-CSV-001 |
| 1.1.0 | 2025-12-20 | エンコード自動判定ロジックを改善 | REQ-CSV-002 |
| 1.2.0 | 2025-12-25 | 日付フォーマット対応を拡張 | REQ-CSV-001 |
```

**ポイント**:
- 1.1.0: 機能追加なので**新規要件ID（REQ-CSV-002）を払い出し**（2.2.6参照）
- 1.2.0: 既存機能のバグ修正なので既存要件ID（REQ-CSV-001）の改訂

##### バージョニング規則

| 変更種別 | バージョン | 例 |
|---------|-----------|-----|
| 破壊的変更（API変更） | メジャー（x.0.0） | 1.0.0 → 2.0.0 |
| 機能追加 | マイナー（0.x.0） | 1.0.0 → 1.1.0 |
| バグ修正・軽微な修正 | パッチ（0.0.x） | 1.0.0 → 1.0.1 |

#### 2.2.6 要件定義書の運用ルール

##### 要件ID払い出しの原則

**機能追加・拡張は、新規要件IDを払い出す**。既存要件定義書の「改訂」は限定的なケースのみ。

| 変更内容 | 対応 | 例 |
|---------|------|-----|
| 新しいプロパティ/メソッド追加 | **新規要件ID払い出し** | author追加 → REQ-VERSION-002 |
| 新しい機能の追加 | **新規要件ID払い出し** | エンコード自動判定 → REQ-CSV-002 |
| 既存動作の変更（破壊的変更） | **新規要件ID払い出し** | 戻り値の型変更 → REQ-xxx-003 |
| バグ修正（仕様通りに修正） | 既存要件IDの改訂 | 実装のバグを修正 |
| 表記修正・明確化 | 既存要件IDの改訂 | 説明文の改善 |
| ドキュメント追加（実装変更なし） | 既存要件IDの改訂 | テスト証跡の追加 |

##### 原則の理由

| 理由 | 説明 |
|------|------|
| **トレーサビリティの明確化** | 「何が追加されたか」を要件ID単位で追跡可能 |
| **影響範囲の特定** | 新機能が原因の問題発生時、該当要件IDから調査開始 |
| **変更履歴の粒度** | 仕様書の変更履歴が要件IDと対応し、変更理由が明確 |
| **レビュー効率化** | PRレビュー時に「この要件IDの実装」と明確に説明可能 |

##### 仕様書の要件ID参照

仕様書は対応する**全ての要件ID**を参照する。

```markdown
**要件ID**: REQ-CSV-001, REQ-CSV-002  ← 複数の要件IDを参照
```

これにより：
- どの要件に基づく仕様かが明確
- 要件変更時の影響範囲を特定可能
- 機能の変遷を追跡可能

##### NG例：既存要件定義書への機能追加

```markdown
# ❌ NG: 既存要件定義書に新機能を直接追記
REQ-VERSION-001.md に「authorプロパティ」を追記

# ✅ OK: 新規要件IDを払い出し
REQ-VERSION-002.md を新規作成（authorプロパティ追加の要件）
```

理由：
- 既存要件定義書を改訂すると「何が元々あったか」が不明瞭になる
- 変更履歴セクションでカバーできるが、要件ID単位の追跡ができない
- 仕様書・テストとの対応関係が曖昧になる

#### 2.2.7 開発中の修正フロー（同一案件の手戻り）

> **注意**: このセクションは**同一案件の開発中**に気づいた設計ミスの修正フローです。
> **既にリリースされた機能への追加・拡張**は、新規要件ID払い出し（2.2.6参照）で対応してください。

開発途中で「設計が違った」と気づいた場合のフロー。

##### 修正が必要になるケース

| 気づいたタイミング | 例 |
|------------------|-----|
| 仕様書作成中 | 要件の解釈が違った |
| テスト作成中 | メソッドの配置場所が違う |
| 実装中 | インターフェースの設計が不適切 |

##### 修正時の原則

**仕様書だけを修正するのはNG**。要件定義書との整合性を常に確認する。

| 変更内容 | 仕様書 | 要件定義書 |
|---------|:------:|:--------:|
| メソッド名変更 | ✓ | ✓ (インターフェース設計) |
| 配置場所変更 | ✓ | ✓ (関連ドキュメント) |
| 引数/戻り値変更 | ✓ | ✓ (インターフェース設計) |
| 内部実装の詳細のみ | ✓ | - |

##### 修正フロー図

```
気づき発生（テスト作成中/実装中）
    │
    ▼
┌─────────────────────────────┐
│ 要件定義書への影響を確認     │
│ - インターフェース設計（案） │
│ - 関連ドキュメント          │
│ - 受け入れ基準              │
└─────────────┬───────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
    ▼                   ▼
影響あり             影響なし
    │                   │
    ▼                   │
要件定義書を修正       │
    │                   │
    └─────────┬─────────┘
              │
              ▼
        仕様書を修正
              │
              ▼
        テストを修正
              │
              ▼
        実装を修正/続行
              │
              ▼
    トレーサビリティ確認
    （全ドキュメントの整合性）
```

##### 大幅な設計変更が必要な場合

以下の場合は、要件定義からやり直すことを検討：

- 機能の目的自体が変わった
- 対象クラス/モジュールが根本的に違った
- 受け入れ基準を満たせない設計だった

この場合、既存の要件定義書のステータスを `Deprecated` にして新規作成するか、バージョンを上げて改訂する。

##### Claude Codeとの協働

設計変更が必要な場合、Claude Codeに相談して修正を進めることができる。

**相談できること:**

| 相談内容 | Claudeの対応 |
|---------|-------------|
| 「この設計だとXXが実現できない」 | 代替案を提案、影響範囲を分析 |
| 「メソッドの配置場所を変えたい」 | 要件定義・仕様書の修正箇所を特定 |
| 「要件自体を見直したい」 | 既存ドキュメントとの差分を整理 |
| 「この修正で他に影響ある？」 | トレーサビリティを辿って確認 |
| 「修正して」 | 要件定義・仕様書・テスト・実装を一括修正 |

**相談例:**

```
「REQ-VERSION-001で、getVersionInfo()をcommonじゃなくてdomainに
置きたくなった。要件定義書と仕様書、どこを直せばいい？」
```

→ Claudeが関連ファイルを読み、修正箇所をリストアップして修正を実行

**Claudeに伝えると良い情報:**

- 何が問題か（現状の設計の不具合）
- どうしたいか（変更後のイメージ）
- 影響範囲の懸念（あれば）

#### 2.2.8 仕様書の必須セクション

案件仕様書（`docs/specs/domain/features/` 配下）には、以下のセクションを**必ず**含めること。

##### 必須セクション一覧

| セクション | 内容 | 備考 |
|-----------|------|------|
| 概要 | 機能の目的、対象ファイル | 要件IDへの参照を含む |
| インターフェース仕様 | 型定義、メソッドシグネチャ | TypeScript形式で記載 |
| 処理仕様 | ロジック、擬似コード | 実装の指針となる内容 |
| テストケース | TC-ID、テスト内容、期待結果 | 正常系・境界値を網羅 |
| **要件トレーサビリティ** | AC-ID → TC-ID の対応表 | **grepで検索可能な形式** |
| 変更履歴 | バージョン、日付、変更内容 | 要件IDを記載 |

##### 要件トレーサビリティセクションの必須性

**重要**: 仕様書に「要件トレーサビリティ」セクションがないと、受け入れ基準（AC-ID）から対応するテストケース（TC-ID）を追跡できない。

**正しい例（grepで検索可能）:**

```markdown
## 要件トレーサビリティ

| 要件ID | 受け入れ基準 | 対応テストケース | 結果 |
|--------|-------------|-----------------|------|
| REQ-XXX AC-01 | 機能の説明 | TC-01, TC-02 | ✅ PASS |
| REQ-XXX AC-02 | 別の機能 | TC-03 | ✅ PASS |
```

**検証方法:**

```bash
# AC-01に対応するテストケースを確認
grep "AC-01" docs/specs/domain/features/Xxx.spec.md
# → | REQ-XXX AC-01 | 機能の説明 | TC-01, TC-02 | ✅ PASS |
```

##### 参考：正しいフォーマットの仕様書

- [`CsvProjectCreator.spec.md`](../specs/domain/master/CsvProjectCreator.spec.md) - セクション10に要件トレーサビリティあり
- [`Project.spec.md`](../specs/domain/master/Project.spec.md) - セクション10に要件トレーサビリティあり
- [`Project.excludedTasks.spec.md`](../specs/domain/features/Project.excludedTasks.spec.md) - セクション7に要件トレーサビリティあり

##### 案件設計書とマスター設計書の同期

**重要**: 案件設計書（`features/`配下）を修正した場合、対応するマスター設計書（`master/`配下）への反映を**必ず**確認すること。

| 案件設計書の変更 | マスター設計書への反映 |
|-----------------|---------------------|
| 要件トレーサビリティの追加・修正 | ✅ 必須（同じ内容を反映） |
| テストケースの追加・修正 | ✅ 必須（テストシナリオセクションに反映） |
| インターフェース仕様の変更 | ✅ 必須（メソッド仕様セクションに反映） |
| 変更履歴の更新 | ✅ 必須（バージョン番号を更新） |

**チェックリストへの追加**:
PRマージ前に「マスター設計書が更新されていること」を確認すること（セクション6.1参照）。

#### 2.2.9 GitHub Issue連携の実践

> **テンプレート**: 完全な要件定義書・設計書テンプレートは SDDスキルの [templates.md](../../.claude/skills/sdd/references/templates.md) を参照。

##### 要件定義書ヘッダー（Issue連携）

要件定義書のヘッダーには必ず `GitHub Issue` フィールドを含める:

```markdown
**要件ID**: REQ-XXX-001
**GitHub Issue**: #nn              ← Issueへのリンク
**作成日**: 2025-12-22
**ステータス**: Draft | Approved | Implemented
**優先度**: High | Medium | Low
```

##### PRテンプレート（Issue連携版）

```markdown
## Summary
- XXX機能を実装

## Related Issue
Closes #nn

## Test plan
- [ ] 単体テスト追加
- [ ] 既存テスト通過確認
```

##### Issueへのドキュメントリンク記載

要件定義書作成後、Issue本文に関連ドキュメントへの参照を追記する。

**記載形式:**

```markdown
---

## 関連ドキュメント

本機能の詳細は以下を参照してください：

- **要件定義書**: `REQ-XXX-001` (`docs/specs/requirements/` 配下)
- **詳細仕様**: `Xxx.spec.md` (`docs/specs/domain/master/` または `features/` 配下)
- **開発ブランチ**: `feature/xxx`

### ドキュメントリンク（mainマージ後に有効）

> **注意**: 以下のリンクは main ブランチへのマージ後に有効になります。それまでは 404 Not Found となります。

- [REQ-XXX-001.md](docs/specs/requirements/REQ-XXX-001.md)
- [Xxx.spec.md](docs/specs/domain/master/Xxx.spec.md)
```

**ポイント:**

| 項目 | 説明 |
|------|------|
| **直リンクを避ける理由** | ブランチ削除後にリンク切れするため |
| **相対パスの注意** | mainマージ前は404になる旨を明記 |
| **開発中の参照** | PRまたは開発ブランチを直接参照 |

##### 既存要件への対応

既にIssueなしで作成された要件定義書（REQ-CSV-001, REQ-VERSION-001）については：

| 対応方針 | 説明 |
|---------|------|
| **後付けIssue作成**（推奨） | 記録として残したい場合に作成 |
| **今後の運用から適用** | 過去分は現状維持、今後のみ適用 |

本プロジェクトでは「今後の運用から適用」を採用。既存要件は参考情報として現状維持。

#### 2.2.10 タスク管理（Task Management）

##### 概要

仕様書からタスクを導出し、進捗を可視化する仕組み。設計書と実装の間を埋め、漏れなく実装するためのツール。

##### ファイル構成

```
docs/specs/domain/features/
├── Order.discount.spec.md     # 案件仕様書
└── Order.discount.tasks.md    # タスク管理（仕様書と同じ場所に配置）
```

##### tasks.md の作成タイミング

| タイミング | 説明 |
|-----------|------|
| 仕様書作成後 | 仕様書からタスクを導出して作成 |
| テスト・実装前 | 何をやるべきかを明確にしてから着手 |

##### タスクの導出方法

仕様書の内容から、以下の観点でタスクを導出する：

| 仕様書のセクション | 導出されるタスク |
|------------------|----------------|
| インターフェース仕様 | 型定義、メソッドシグネチャの実装 |
| 処理仕様 | メソッド実装、エラーハンドリング |
| テストケース | 各TC-IDに対応するテストコード作成 |
| 要件トレーサビリティ | トレーサビリティ更新、マスター設計書反映 |

##### 標準タスク一覧

新規機能開発時の標準的なタスク構成：

| # | タスク | 成果物 |
|---|--------|--------|
| 1 | 要件定義書作成 | `REQ-XXX-001.md` |
| 2 | 詳細仕様書作成 | `{機能名}.spec.md` |
| 3 | インターフェース定義 | 型定義 |
| 4 | テストコード作成 | `{機能名}.test.ts` |
| 5 | 実装 | `{対象ファイル}.ts` |
| 6 | 統合テスト | 全テストPASS |
| 7 | トレーサビリティ更新 | 仕様書更新 |
| 8 | マスター設計書反映 | `master/{クラス名}.spec.md` |

##### 進捗管理

tasks.md 内で進捗を管理する：

| 状態 | 表記 | 意味 |
|------|------|------|
| Todo | ⬜ | 未着手 |
| In Progress | 🔄 | 作業中 |
| Done | ✅ | 完了 |
| Blocked | ⏸️ | ブロック中 |

##### テンプレート

タスク管理ファイルのテンプレート: SDDスキルの [templates.md](../../.claude/skills/sdd/references/templates.md#3-タスク管理テンプレート) を参照。

##### 運用ルール

| ルール | 説明 |
|--------|------|
| **仕様書と同じ場所に配置** | `features/` 内に `{機能名}.tasks.md` として作成 |
| **タスク完了時に更新** | 状態を ⬜ → 🔄 → ✅ と更新 |
| **PRマージ前に全タスク完了** | 全タスクが ✅ Done になっていることを確認 |
| **進捗サマリーを維持** | 進捗率を定期的に更新 |

##### GitHub Issueとの関係

tasks.md は **機能単位の詳細タスク** を管理する。GitHub Issue は **全体の進捗** を管理する。

```
GitHub Issue #42         tasks.md
┌─────────────┐          ┌─────────────────────────┐
│  全体の進捗  │          │  詳細タスク一覧          │
│  Status:    │    ──▶   │  1. ⬜ 要件定義         │
│  In Progress│          │  2. ✅ 仕様書作成        │
│             │          │  3. 🔄 テスト作成        │
└─────────────┘          │  4. ⬜ 実装             │
                         │  ...                    │
                         └─────────────────────────┘
```

| 管理対象 | GitHub Issue | tasks.md |
|---------|-------------|----------|
| 全体ステータス | ✅ | - |
| 詳細タスク | - | ✅ |
| 進捗率 | - | ✅ |
| 担当者 | ✅ | △（必要に応じて） |
| 期限 | ✅ | - |

### 2.3 ブランチ構成（Git Flow）

#### 2.3.1 ブランチ図

```
                         ┌─────────────────────────────────────────┐
                         │              main                       │
                         │   (本番リリース用・タグ付け)             │
                         └──────────────┬────────────────────────┬─┘
                                        │                        │
         ┌──────────────────────────────┼────────────────────────┼──┐
         │                              ▼                        ▼  │
         │  ┌─────────────────────────────────────────────────────┐ │
         │  │                    develop                          │ │
         │  │              (開発統合ブランチ)                      │ │
         │  └───┬─────────────────┬─────────────────┬─────────────┘ │
         │      │                 │                 │               │
         │      ▼                 ▼                 ▼               │
         │  ┌────────┐       ┌────────┐       ┌────────┐           │
         │  │feature/│       │feature/│       │release/│           │
         │  │  xxx   │       │  yyy   │       │ 0.0.x  │           │
         │  └────────┘       └────────┘       └────────┘           │
         │                                                         │
         └─────────────────────────────────────────────────────────┘
```

#### 2.3.2 ブランチの役割

| ブランチ | 命名規則 | 目的 | ライフサイクル |
|---------|---------|------|---------------|
| `main` | - | 本番リリース用。常に安定版 | 永続 |
| `develop` | - | 開発統合。次リリースの準備 | 永続 |
| `feature/*` | `feature/{issue番号}-{機能名}` | 新機能開発 | 一時的（PR後削除） |
| `release/*` | `release/{バージョン}` | リリース準備 | 一時的（マージ後削除） |
| `hotfix/*` | `hotfix/{修正名}` | 緊急バグ修正 | 一時的（マージ後削除） |

**featureブランチ命名規則:**
- 形式: `feature/{issue番号}-{機能名}`
- 例: `feature/42-excluded-tasks`, `feature/41-workload-summary`
- 理由: Issue Firstワークフローと整合性があり、GitHub連携（`#42`）が活きる

#### 2.3.3 実際のブランチ例（本リポジトリより）

```
remotes/origin/main                        # 本番
remotes/origin/develop                     # 開発統合
remotes/origin/feature/resourcePlansCreator  # 要員計画機能
remotes/origin/feature/invalid             # validStatus機能
```

### 2.4 Feature開発フロー（Git操作）

**git worktreeを使用**して、別ディレクトリでfeatureブランチを作業する。

```bash
# 1. developから feature ブランチを作成（worktree、--no-track でトラッキングなし）
git fetch origin
git worktree add -b feature/42-csv-reader ../evmtools-node_feature-42-csv-reader origin/develop --no-track
# Issue #42 の場合

# 2. 作業ディレクトリに移動
cd ../evmtools-node_feature-42-csv-reader

# 3. 依存関係のインストール
npm install

# 4. 開発作業（仕様駆動開発サイクル）
#    - 要件定義書作成
#    - 仕様書作成
#    - テストコード作成
#    - 実装
#    - テスト実行・修正

# 5. コミット
git add .
git commit -m "feat: CSVファイルからProjectを生成する機能を追加"

# 6. リモートにプッシュ（-u で正しいリモートブランチをトラッキング設定）
git push -u origin feature/42-csv-reader

# 7. Pull Request作成（GitHub）
gh pr create --base develop --title "feat: CSV読み込み機能"

# 8. レビュー・マージ後、worktreeを削除
cd ../evmtools-node  # 元のディレクトリに戻る
git worktree remove ../evmtools-node_feature-42-csv-reader
git branch -d feature/42-csv-reader  # ローカルブランチも削除
git fetch --prune origin  # リモートの削除されたブランチを反映
```

> **git worktreeのメリット**:
> - 現在の作業ディレクトリを維持したまま、別ブランチで並行作業できる
> - `git stash`や`git checkout`による切り替えが不要
> - 複数の機能を同時に開発する場合に便利
>
> **注意**: `--no-track` を指定しないと `origin/develop` をトラッキングしてしまい、push 時にエラーになる。

### 2.5 リリースフロー

> **注意**: main/develop ブランチは直接 push が禁止されています。全ての変更は PR 経由で行います。

#### 2.5.1 リリースブランチでの作業

release ブランチでは以下の作業を行う:

| # | 作業 | 成果物 |
|---|------|--------|
| 1 | バージョン更新 | `package.json` |
| 2 | リリースノート作成 | `CHANGELOG.md` |
| 3 | テスト実行 | 全テストPASS確認 |

```bash
# 1. developからreleaseブランチを作成（--no-track でトラッキングなし）
git fetch origin
git checkout -b release/0.0.18 origin/develop --no-track

# 2. バージョン更新
npm version 0.0.18 --no-git-tag-version

# 3. CHANGELOG.md更新（リリースノート作成）
# CHANGELOG.md に今回のリリース内容を追記

# 4. テスト実行
npm test

# 5. コミット・プッシュ
git add package.json CHANGELOG.md
git commit -m "chore: bump version to 0.0.18"
git push -u origin release/0.0.18
```

##### CHANGELOG.md の記載内容

```markdown
## [0.0.18]

### 追加
- **機能名**: 説明 (#Issue番号)

### 改善
- **改善内容**: 説明 (#Issue番号)

### 修正
- **バグ修正**: 説明 (#Issue番号)
```

> **注意**: ドキュメント修正のみのリリースは CHANGELOG に記載不要。

#### 2.5.2 main へのマージとタグ作成

```bash
# 6. mainへのPR作成・マージ
gh pr create --base main --title "Release 0.0.18" --body "Release 0.0.18"
gh pr merge --merge

# 7. タグ作成・プッシュ
git fetch origin
git checkout main
git pull origin main
git tag v0.0.18
git push origin v0.0.18
```

#### 2.5.3 GitHub Release 作成

タグ作成後、GitHub Release を作成する。CHANGELOG.md の内容を転記する。

```bash
# 8. GitHub Release作成
gh release create v0.0.18 --title "v0.0.18" --notes "$(cat <<'EOF'
## 追加
- **機能名**: 説明 (#Issue番号)

## 改善
- **改善内容**: 説明 (#Issue番号)
EOF
)"
```

#### 2.5.4 develop へのマージバック

```bash
# 9. developへの同期（PR経由）
gh pr create --base develop --head main --title "chore: sync main to develop (v0.0.18)" --body "main の v0.0.18 を develop に同期"
gh pr merge --merge --admin  # レビュー不要の場合

# 10. クリーンアップ
git checkout develop
git pull origin develop
git branch -d release/0.0.18
git fetch --prune origin
```

#### 2.5.5 develop の SNAPSHOT バージョン更新

> **重要**: develop ブランチが保護されている場合、直接プッシュできないため PR 経由で更新する。

```bash
# 11. SNAPSHOT更新用ブランチを作成
git fetch origin
git checkout -b chore/snapshot-version origin/develop --no-track

# 12. バージョンを次版SNAPSHOTに更新
npm version 0.0.19-SNAPSHOT --no-git-tag-version

# 13. コミット・プッシュ
git add package.json
git commit -m "chore: bump version to 0.0.19-SNAPSHOT"
git push -u origin chore/snapshot-version

# 14. PR作成・マージ
gh pr create --base develop --title "chore: bump version to 0.0.19-SNAPSHOT" --body "リリース v0.0.18 後の開発版バージョンに更新"
gh pr merge --merge --admin  # レビュー不要の場合

# 15. クリーンアップ
git checkout main
git branch -d chore/snapshot-version
git fetch --prune origin
```

---

## 3. コミットメッセージ規約

### 3.1 フォーマット

```
<type>: <subject>

[body]

[footer]
```

### 3.2 Type一覧

| Type | 説明 | 例 |
|------|------|-----|
| `feat` | 新機能 | `feat: CSV読み込み機能を追加` |
| `fix` | バグ修正 | `fix: 日付パースの不具合を修正` |
| `docs` | ドキュメント | `docs: README更新` |
| `refactor` | リファクタリング | `refactor: TaskRow計算処理を整理` |
| `test` | テスト | `test: CsvProjectCreatorのテスト追加` |
| `chore` | その他 | `chore: 依存関係更新` |

---

## 4. バージョニング

### 4.1 セマンティックバージョニング

```
MAJOR.MINOR.PATCH
  │     │     │
  │     │     └── バグ修正（後方互換あり）
  │     └──────── 機能追加（後方互換あり）
  └────────────── 破壊的変更（後方互換なし）
```

### 4.2 開発中バージョン（SNAPSHOT）

開発中のバージョンには `-SNAPSHOT` サフィックスを付与し、リリース済みバージョンと区別する。

#### 4.2.1 バージョン命名規則

| フェーズ | バージョン例 | 説明 |
|---------|------------|------|
| リリース済み | `0.0.17` | npm publishされた安定版 |
| 開発中（develop） | `0.0.18-SNAPSHOT` | 次リリースに向けた開発版 |
| 開発中（feature） | `0.0.18-SNAPSHOT.cli-npx` | 機能開発版（**必須**） |

#### 4.2.2 運用フロー

```
main (0.0.17)                          ← リリース済み
  │
  └── develop (0.0.18-SNAPSHOT)        ← 次版開発中
        │
        ├── feature/cli-npx (0.0.18-SNAPSHOT.cli-npx)
        │                              ↑ featureブランチでは必ず機能名を付与
        └── feature/csv (0.0.18-SNAPSHOT.csv)
```

1. **リリース後**: developのバージョンを `X.Y.Z-SNAPSHOT` に更新
2. **feature開発時**: `X.Y.Z-SNAPSHOT.機能名` に変更（**必須**）
   - 理由: 他の開発者が同時にブランチを切っている可能性があり、push前は検知できないため
3. **developマージ時**: `X.Y.Z-SNAPSHOT` に戻す
4. **リリース時**: `-SNAPSHOT` を削除して `X.Y.Z` に

#### 4.2.3 semver準拠

`-SNAPSHOT` はsemverの有効なプレリリース識別子。バージョン比較:

```
0.0.17 < 0.0.18-SNAPSHOT < 0.0.18-SNAPSHOT.cli-npx < 0.0.18
```

#### 4.2.4 npm pack時の区別

featureブランチでは機能名サフィックスを付けるため、ビルド成果物を区別可能:

```bash
# feature/cli-npx ブランチ
npm version 0.0.18-SNAPSHOT.cli-npx --no-git-tag-version
npm pack
# → evmtools-node-0.0.18-SNAPSHOT.cli-npx.tgz
```

### 4.3 本プロジェクトのバージョン履歴

| バージョン | 主な変更 |
|-----------|---------|
| 0.0.17 | validStatusプロパティ追加 |
| 0.0.15 | 微調整 |
| 0.0.14 | リファクタリング、要員計画β版 |
| 0.0.13 | Diffに工数プロパティ追加 |
| ... | ... |

---

## 5. 本リポジトリのGitグラフ（実例）

```
*   Merge tag '0.0.17' into develop          (develop)
|\
| *   Merge branch 'release/0.0.17'          (main)
| |\
| | * 0.0.17                                  ← タグ: 0.0.17
| |/
|/|
* |   Merge pull request #43 feature/invalid  ← PR: validStatus
|\ \
| * | TaskRow : validStatusプロパティを追加
|/ /
* | Merge tag '0.0.15' into develop
|\|
| *   Merge branch 'release/0.0.15'
| |\
| | * 0.0.15
...
```

**特徴:**
- `feature/*` → `develop` へのPRマージ
- `release/*` → `main` へのマージでタグ作成
- タグを `develop` にもマージして同期

---

## 6. チェックリスト

### 6.1 Feature開発時

- [ ] **GitHub Issueを作成（または既存Issueを確認）**
- [ ] `develop`から`feature/{issue番号}-{機能名}`ブランチを作成
- [ ] **バージョンを `X.Y.Z-SNAPSHOT.機能名` に変更**
- [ ] 要件定義書を作成（**GitHub Issue欄に#nnを記載**）
- [ ] 仕様書を作成
- [ ] **タスク管理ファイルを作成**（`{機能名}.tasks.md`）
- [ ] テストコードを作成
- [ ] 実装
- [ ] 全テストPASS確認
- [ ] トレーサビリティ更新
- [ ] **タスク管理ファイルの全タスクが完了していることを確認**
- [ ] **バージョンを `X.Y.Z-SNAPSHOT` に戻す**
- [ ] PRを作成（**`Closes #nn`を記載**）
- [ ] レビュー・マージ

### 6.2 リリース時

#### release ブランチ内での作業
- [ ] `develop`から`release/*`ブランチを作成（`--no-track`オプション必須）
- [ ] バージョン番号更新（`-SNAPSHOT` を削除）
- [ ] CHANGELOG.md 更新（リリースノート作成）
- [ ] テスト実行・全テストPASS確認
- [ ] コミット・プッシュ

#### main マージ後の作業
- [ ] `main`へのPR作成・マージ
- [ ] タグ作成・プッシュ
- [ ] **GitHub Release 作成**（CHANGELOG の内容を転記）
- [ ] `develop`へのマージバック（PR経由）
- [ ] **developのバージョンを次版SNAPSHOTに更新**（例: `0.0.19-SNAPSHOT`）
  - ⚠️ develop が保護されている場合は **PR経由** で更新（詳細: 2.5.5 参照）
- [ ] npm publish（必要に応じて）

---

## 7. 関連ドキュメント

| ドキュメント | パス | 説明 |
|-------------|------|------|
| CLAUDE.md | `/CLAUDE.md` | プロジェクト技術ガイド |
| CHANGELOG.md | `/CHANGELOG.md` | 変更履歴 |
| 要件定義書 | `docs/specs/requirements/` | 機能要件 |
| 仕様書 | `docs/specs/domain/master/`, `features/` | 詳細設計 |

---

## 8. 補足：現在の状態

**2025-12-16時点:**

`feature/claude-code-setup`ブランチで以下の作業を実施中:
- Claude Code導入（CLAUDE.md）
- 仕様駆動開発の導入（Jest環境、仕様書）
- CsvProjectCreator機能の開発（仕様駆動開発フローで実装）

Git Flowに従い、`develop`から分岐 → PR → `develop`へマージ の流れで進行。
